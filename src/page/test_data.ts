module test {
	export class test_data extends egret.Sprite{
		public constructor() {
			super();
			let arr = [{
				"x": 331,
				"y": 238,
				"t": "line",
				"p": "-52 0 52.11 0.78"
			}, {
				"x": 397,
				"y": 239,
				"t": "line",
				"p": "-13.89 -0.22 14.75 0"
			}, {
				"x": 464,
				"y": 239,
				"t": "line",
				"p": "-52.25 0 51.65 0.78"
			}, {
				"x": 530,
				"y": 240,
				"t": "line",
				"p": "-14.35 -0.22 15 0"
			}, {
				"x": 516,
				"y": 223,
				"t": "line",
				"p": "0 -17 -0.35 16.78"
			}, {
				"x": 515,
				"y": 267,
				"t": "line",
				"p": "0.65 -27.22 0.1 26.23"
			}, {
				"x": 515,
				"y": 298,
				"t": "line",
				"p": "0.1 -4.77 0 5"
			}, {
				"x": 505,
				"y": 293,
				"t": "line",
				"p": "-11 0 10.1 0.23"
			}, {
				"x": 537,
				"y": 293,
				"t": "line",
				"p": "-21.9 0.23 22.1 0.71"
			}, {
				"x": 624,
				"y": 294,
				"t": "line",
				"p": "-64.9 -0.29 65.05 1.14"
			}, {
				"x": 721,
				"y": 295,
				"t": "line",
				"p": "-31.95 0.14 31.18 0.83"
			}, {
				"x": 760,
				"y": 296,
				"t": "line",
				"p": "-7.82 -0.17 8 0"
			}, {
				"x": 559,
				"y": 291,
				"t": "line",
				"p": "0 -2 0.1 2.71"
			}, {
				"x": 560,
				"y": 341,
				"t": "line",
				"p": "-0.9 -47.29 1 47"
			}, {
				"x": 383,
				"y": 237,
				"t": "line",
				"p": "0 -2 0.11 1.78"
			}, {
				"x": 386,
				"y": 346,
				"t": "line",
				"p": "-2.89 -107.22 3.21 107.98"
			}, {
				"x": 390,
				"y": 468,
				"t": "line",
				"p": "-0.79 -14.02 0 14"
			}, {
				"x": 331,
				"y": 453,
				"t": "line",
				"p": "-59 0 58.21 0.98"
			}, {
				"x": 391,
				"y": 454,
				"t": "line",
				"p": "-1.79 -0.02 1 0"
			}, {
				"x": 408,
				"y": 107,
				"t": "line",
				"p": "0 -2 0.11 2.03"
			}, {
				"x": 410,
				"y": 174,
				"t": "line",
				"p": "-1.89 -64.97 1.75 65"
			}, {
				"x": 412,
				"y": 244,
				"t": "line",
				"p": "-0.25 -5 0 4"
			}, {
				"x": 334,
				"y": 110,
				"t": "line",
				"p": "-74 0 74.11 -0.97"
			}, {
				"x": 411,
				"y": 109,
				"t": "line",
				"p": "-2.89 0.03 2 0"
			}, {
				"x": 754,
				"y": 233,
				"t": "line",
				"p": "1 -62 -1.82 62.83"
			}, {
				"x": 752,
				"y": 300,
				"t": "line",
				"p": "0.18 -4.17 0 4"
			}, {
				"x": 689,
				"y": 293,
				"t": "line",
				"p": "0 -3 0.05 2.14"
			}, {
				"x": 690,
				"y": 382,
				"t": "line",
				"p": "-0.95 -86.86 0.85 86.68"
			}, {
				"x": 691,
				"y": 476,
				"t": "line",
				"p": "-0.15 -7.32 0 7"
			}, {
				"x": 687,
				"y": 469,
				"t": "line",
				"p": "-4 0 3.85 -0.32"
			}, {
				"x": 736,
				"y": 467,
				"t": "line",
				"p": "-45.15 1.68 46 -2"
			}]

			arr = [
              {
                "x": 139,
                "y": 291,
                "t": "line",
                "p": "-19 0 19 0.05"
              },
              {
                "x": 252,
                "y": 291,
                "t": "line",
                "p": "-94 0.05 93.47 0.27"
              },
              {
                "x": 361,
                "y": 291,
                "t": "line",
                "p": "-15.53 0.27 16.4 0.31"
              },
              {
                "x": 434,
                "y": 291,
                "t": "line",
                "p": "-56.6 0.31 57.5 0.44"
              },
              {
                "x": 551,
                "y": 292,
                "t": "line",
                "p": "-59.5 -0.56 59.81 -0.41"
              },
              {
                "x": 638,
                "y": 292,
                "t": "line",
                "p": "-27.19 -0.41 28.03 -0.35"
              },
              {
                "x": 723,
                "y": 292,
                "t": "line",
                "p": "-56.97 -0.35 56.38 -0.21"
              },
              {
                "x": 814,
                "y": 292,
                "t": "line",
                "p": "-34.62 -0.21 35.17 -0.13"
              },
              {
                "x": 902,
                "y": 292,
                "t": "line",
                "p": "-52.83 -0.13 53 0"
              },
              {
                "x": 158,
                "y": 279,
                "t": "line",
                "p": "0 -13 0 12.05"
              },
              {
                "x": 158,
                "y": 343,
                "t": "line",
                "p": "0 -51.95 0 52"
              },
              {
                "x": 346,
                "y": 278,
                "t": "line",
                "p": "0 -13 -0.53 13.27"
              },
              {
                "x": 344,
                "y": 353,
                "t": "line",
                "p": "1.47 -61.73 -1 62"
              },
              {
                "x": 377,
                "y": 277,
                "t": "line",
                "p": "-1 -14 0.4 14.31"
              },
              {
                "x": 380,
                "y": 346,
                "t": "line",
                "p": "-2.6 -54.69 2.77 54"
              },
              {
                "x": 383,
                "y": 413,
                "t": "line",
                "p": "-0.23 -13 1 12"
              },
              {
                "x": 844,
                "y": 273,
                "t": "line",
                "p": "-6 -18 5.17 18.87"
              },
              {
                "x": 870,
                "y": 361,
                "t": "line",
                "p": "-20.83 -69.13 21 69"
              },
              {
                "x": 492,
                "y": 278,
                "t": "line",
                "p": "-0.5 -12.5 -0.5 13.44"
              },
              {
                "x": 492,
                "y": 353,
                "t": "line",
                "p": "-0.5 -61.56 -0.5 61.5"
              },
              {
                "x": 666,
                "y": 288,
                "t": "line",
                "p": "0 -4 0.03 3.65"
              },
              {
                "x": 666,
                "y": 348,
                "t": "line",
                "p": "0.03 -56.35 0.5 55.5"
              },
              {
                "x": 379,
                "y": 400,
                "t": "line",
                "p": "-3.5 0 3.77 0"
              },
              {
                "x": 404,
                "y": 400,
                "t": "line",
                "p": "-21.23 0 22 0"
              },
              {
                "x": 611,
                "y": 284,
                "t": "line",
                "p": "-0.5 -7.5 -0.19 7.59"
              },
              {
                "x": 612,
                "y": 346,
                "t": "line",
                "p": "-1.19 -54.41 1 54"
              },
              {
                "x": 779,
                "y": 280,
                "t": "line",
                "p": "0 -12 0.38 11.79"
              },
              {
                "x": 780,
                "y": 343,
                "t": "line",
                "p": "-0.62 -51.21 1 50.5"
              }
            ]

			this.graphics.lineStyle(1,0xff0000);
			console.log(arr.length);

			let points = [];

			let p1:egret.Point = new egret.Point();
			let p2:egret.Point = new egret.Point();

			//点分类
			let pointsArr:any[][] = [];
			let wMatrix:number[][] = [];


			arr.forEach(element => {
				let pArr = element.p.split(' ');
				let sx = parseFloat(pArr[0]) + element.x;
				let sy = parseFloat( pArr[1]) + element.y;
				let tx = parseFloat(pArr[2]) + element.x;
				let ty = parseFloat( pArr[3]) + element.y;

				this.graphics.moveTo(parseFloat(pArr[0]) + element.x,parseFloat( pArr[1]) + element.y);
				this.graphics.lineTo(parseFloat(pArr[2]) + element.x,parseFloat( pArr[3]) + element.y);
				console.log('sx:' + sx + ' sy:' + sy + ' tx:' + tx + ' ty:' + ty);

				// p2.x = sx;
				// p2.y = sy;

				// egret.Point.distance(p,p2);

				let temp = [{x:sx,y:sy},{x:tx,y:ty}];
				let ids = [];
				temp.forEach(element => {
					// let min:number = 0;
					p1.x = element.x;
					p1.y = element.y;

					let minValue:number = 2;
					let minIndex;
					for(let i:number = 0; i < pointsArr.length;i++){
						let list = pointsArr[i];
						if(list){
							p2.x = list[0].x;
							p2.y = list[0].y;
							let dis = egret.Point.distance(p1,p2);
							if(dis < minValue){
								minValue = dis;
								minIndex = i;
							}
						} 
					}	
					if(minIndex == undefined){
						minIndex = pointsArr.length;
					}
					if(pointsArr[minIndex] == null){
						pointsArr[minIndex] = [];
					}					
					pointsArr[minIndex].push({x:element.x,y:element.y});
					ids.push(minIndex);
				});


				let i1 = ids[0];
				let i2 = ids[1];
				let t;
				if(i1 > i2){
					t = i1;
					i1 = i2;
					i2 = t;
				}

				if(wMatrix[i1] == null){
					wMatrix[i1] = [];
				}

				p1.x = sx;
				p1.y = sy;
				p2.x = tx;
				p2.y = ty;
				wMatrix[i1][i2] = egret.Point.distance(p1,p2) | 0;
			});

			let vetexs:any[] = [];

			for(let i:number = 0; i < pointsArr.length;i++){
				vetexs.push(pointsArr[i][0]);
			}

			console.log('vetexs:' + vetexs.length);
			//绘制顶点
			let p;
			let v;
			for(let i = 0; i < vetexs.length;i++){
				v = vetexs[i];
				p = new P(i);
				p.x = v.x;
				p.y = v.y;
				this.addChild(p);
			}

			// return;

			let d = new eg.Dijkstra(vetexs,wMatrix);
			let paths = d.find(0,26);
			console.log(paths);

			this.vetexs = vetexs;
			this.paths = paths;

			let player = new Player();

			// egret.Tween.get(player).to({})

			let id = paths.shift();
			player.x = vetexs[id].x;
			player.y = vetexs[id].y;
			this.player = player;

			this.addChild(player);

			this.addEventListener(egret.Event.ENTER_FRAME,this.onEnterFrame,this);

			this.nextPos();
		}

		private nextPos():void{
			let id = this.paths.shift();
			if(id){
				let vetex = this.vetexs[id];
				let dis = egret.Point.distance(new egret.Point(this.player.x,this.player.y),new egret.Point(vetex.x,vetex.y));
				this.count = (dis / this.speed) | 0;
				let degrees = Math.atan2(vetex.y - this.player.y,vetex.x - this.player.x);
				this.vx = Math.cos(degrees) * this.speed;
				this.vy = Math.sin(degrees) * this.speed;

			}
		}

		private onEnterFrame(evt:egret.Event):void{

			if(this.count > 0){
				this.player.x += this.vx;
				this.player.y += this.vy;
				this.count--;
				if(this.count == 0){
					this.nextPos();
				}
			}

		}

		private paths:number[];
		private vetexs:any[];
		private speed = 5;
		private vx:number;
		private vy:number;
		private count:number = 0;
		private player:Player;


	}

	class P extends egret.Sprite{
		constructor(id:number){
			super();
			this.graphics.beginFill(0x00ff00);
			// this.graphics.drawCircle(0,0,3);
			this.graphics.endFill();
			let tf = new egret.TextField();
			tf.text = id + "";
			tf.size = 12;
			// tf.border = true;
			tf.anchorOffsetX = tf.width / 2;
			tf.anchorOffsetY = tf.height / 2;
			this.addChild(tf);
		}	
	}

	class Player extends egret.Sprite{
		constructor(){
			super();
			this.graphics.beginFill(0x0000ff);
			this.graphics.drawCircle(0,0,3);
			this.graphics.endFill();
		}		
	}
}